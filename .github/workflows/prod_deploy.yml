name: PROD DEPLOY

on:
  push:
    tags: [ 'v*' ]

jobs:
  deploy-convox:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1

    - uses: convox/action-deploy@v1
      name: Deploy to Convox
      with:
        rack: prod-internal
        app: roadrunner
        password: ${{ secrets.CONVOX_DEPLOY_KEY }}

    - name: login
      id: login
      uses: convox/action-login@v1
      with:
        password: ${{ secrets.CONVOX_DEPLOY_KEY }}

    - uses: convox/action-run@v1
      name: Run migrations
      with:
        rack: prod-internal
        app: roadrunner
        command: 'rails db:migrate && rails datab:migrate'


    - name: Notify deployment
      uses: codelittinc/action-roadrunner-notify-deploy@master
      with:
        domain: api.roadrunner.codelitt.dev
        environment: prod